<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="stylesheet" href="../style.css">
  <link rel="stylesheet" href="../simple-console.css">
  <script src="../simple-console.js"></script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="mobile-web-app-capable" content="yes">
  <!-- The core Firebase JS SDK is always required and must be listed first -->
  <script src="https://www.gstatic.com/firebasejs/7.14.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.14.2/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.14.2/firebase-auth.js"></script>



</head>

<body>
  
  <video controls id="yourVideo" autoplay></video>
  <video controls id="friendsVideo" autoplay></video>
  <button>start</button>
  <button id=bc>broadcast</button>
  <button id=friend>friend</button>
  <div>a
    <canvas id='a'></canvas>
  </div>
  <div>b
    <canvas id='b'></canvas>
  </div>
  <div>
    <canvas id='b1'></canvas>

    <canvas id='a1'></canvas>
    <canvas id='bands_freq_out'></canvas>
  </div>
  <div id=name>

  </div>
  <div id=channels>

  </div>
  <div id='ctrls'></div>

  <script src='../polyfills.js'></script>
  <script type="module">

    import Mixer from '../Mixer.js';
    import { histogram2, chord, slider } from '../functions.js';
    import twitch from '../twitch_audio.js'

    var yourVideo = document.getElementById("yourVideo");
    var friendsVideo = document.getElementById("friendsVideo");

    var userId = window.location.search.replace("?","") || localStorage.getItem("uid") ||  ("user_" + Math.floor(Math.random() * 10));
    
    localStorage.setItem('uid', userId);


    $("#name").innerHTML = userId;
    const div = $("#channels");
    
    function displaychannel(channel) {
      const channelval = channel.val();
      if(channelval.online == false) return;

      div.appendstr("<li>" + JSON.stringify(channel.val()) + "</li>");
      var a = document.createElement("a");
      a.onclick = function () {
        twitch.watch(userId, channelval['id']);
      }
      a.innerText = "watch";
      div.append(a);
    }

    twitch.channels(function (list) {
      list.forEach(channel => displaychannel(channel));
    }, function (newchannel) {
      displaychannel(newchannel)
    });


    // pc.ontrack=function(e){
    //   if(e.track){
    //     remoteStream = window.g_audioCtx.createMediaStreamTrackSource(e.track)
    //     remoteStream.connect(window.g_audioCtx.destination)
    //     friendsVideo.srcObject = recomoteStream;
    // }}
    // pc.ontrack = (e=> friendsVideo.stream.addTrack(e.track))



    $("button").onclick = async function (evt) {
      const ctx = await new AudioContext();

      window.g_audioCtx = ctx;
      let a = ctx.createAnalyser(), b = ctx.createAnalyser(), c = ctx.createAnalyser();
      let a1 = ctx.createAnalyser(), b1 = ctx.createAnalyser(), c1 = ctx.createAnalyser();


      twitch.broadcast(ctx, userId);

    }




  </script>
</body>

</html>