<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>rt</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mui/3.7.1/css/mui.min.css"
        integrity="sha256-Ryx96brW7LDribCqmld/zV3Rnt2cEGIo0XnhSPkbkTM=" crossorigin="anonymous" />
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <link rel="stylesheet" href="./simple-console.css">
    <script src="./simple-console.js"></script>
    <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>

</head>

<body>
<button>start</button>
<div id=console style='position:fixed;right:0;bottom:0'></div>
</body>
<script src='polyfills.js'></script>

<script type='module'>
    import AnalyzerView from './AnalyzerView.js';
    import Envelope from './envelope.js';

    let ctx;
    async function start(deviceId) {
        try {
            ctx = new AudioContext();
            var audioCtx = ctx;
            var audioContext = ctx;
            var ampEnvelopeGain = ctx.createGain();

            var ampAttack = 0.1;
            var ampDecay = 0.1;
            var ampSustain = 0.2;
            var ampRelease = 0.02;
            var adsrs = [];
            const keys = 'asdfghj'.split("");
            const nodes = '65.41, 73.42, 82.41,87.31,98.00,110.00,123.47'.split(",");
            var masterGain = ctx.createGain();

            keys.forEach((l, i) => {
                var LFO = ctx.createOscillator();
                LFO.frequency.value = nodes[i];
                var gain = ctx.createGain();
                gain.gain.value = 0;
                var gainEnvelope = new Envelope(0, 2, ampAttack, ampDecay, ampSustain, ampRelease, gain.gain);
                adsrs.push(gainEnvelope)
                LFO.connect(gain);
                LFO.start(0);
                gain.connect(masterGain);

            })

            window.addEventListener("keydown", function (e) {
                if (keys.indexOf(e.key) > -1) {
                    log('keydown')
                    var env = adsrs[keys.indexOf(e.key)];
                    env.trigger(ctx.currentTime);
                }
            })

            window.addEventListener("keyup", function (e) {
                if (keys.indexOf(e.key) > -1) {
                    log('keyup')
                    var env = adsrs[keys.indexOf(e.key)];
                    env.release(ctx.currentTime);
                }
            })
            var analyser = audioCtx.createAnalyser();
            masterGain.connect(audioCtx.destination)
            // Bind our analyser to the media element source.
            masterGain.connect(analyser);
            analyser.connect(audioCtx.destination);

            var frequencyData = new Uint8Array(200);
            var svgHeight = '700';
            var svgWidth = '1200';
            var barPadding = '1';



            function createSvg(parent, height, width) {
                return d3.select(parent).append('svg').attr('height', height).attr('width', width);
            }


            var svg = createSvg('body', svgHeight, svgWidth);

            // Create our initial D3 chart.
            svg.selectAll('rect')
                .data(frequencyData)
                .enter()
                .append('rect')
                .attr('x', function (d, i) {
                    return i * (svgWidth / frequencyData.length);
                })
                .attr('width', svgWidth / frequencyData.length - barPadding);

            function renderChart() {
                requestAnimationFrame(renderChart);

                // Copy frequency data to frequencyData array.
                analyser.getByteFrequencyData(frequencyData);
                // Update d3 chart with new data.
                svg.selectAll('rect')
                    .data(frequencyData)
                    .attr('y', function (d) {
                        return svgHeight - d;
                    })
                    .attr('height', function (d) {
                        return d;
                    })
                    .attr('fill', function (d) {
                        return 'rgb(0, 0, ' + d + ')';
                    });
            }

            // Run the loop
            renderChart();



            return source;
        } catch (eerrr) {
            console.log(eerrr.message);
        }
    }
    $("button").onclick = function (e) {
        start();
    }
</script>

</body>

</html>