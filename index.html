<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="stylesheet" href="../style.css">
  <link rel="stylesheet" href="../simple-console.css">
  <script src="../simple-console.js"></script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="mobile-web-app-capable" content="yes">
</head>

<body>
  <button>start</button>
 <div id=bg1>

 </div>
<div>
  <canvas id='a'></canvas>
</div>
<div>b
  <canvas id='b'></canvas>
</div>
<div>
  <canvas id='b1'></canvas>

  <canvas id='a1'></canvas>
  <canvas id='c1'></canvas>

</div>
  <div id='ctrls'></div>
  <button>start</button>

  <script src='../polyfills.js'></script>
  <script type="module">
    import SharedBufferWorkletNode from './shared-buffer-worklet-node.js';
    import Mixer from '../Mixer.js';
    import { histogram2, chord,slider } from '../functions.js';
    import Effects from '../effects.js';

    Effects.addImpulseButtons('bg1');


    $("button").onclick = async function (evt) {
      
      const ctx =await new AudioContext();
      window.g_audioCtx = ctx;
      await ctx.audioWorklet.addModule('./shared-buffer-worklet-processor.js');





      const sbwNode = new SharedBufferWorkletNode(ctx);

    Effects.addImpulseButtons('bg1');

      sbwNode.onInitialized = async function (){
        let a = ctx.createAnalyser(), b = ctx.createAnalyser(), c = ctx.createAnalyser();
        let a1 = ctx.createAnalyser(), b1 = ctx.createAnalyser(), c1 = ctx.createAnalyser();

         var source = await chord("/samples/Piano");
  
        Effects.addImpulseButtons(source, 'bg1');

        function getCombFilter(audioCtx){
            const node = audioCtx.createGain()
            const lowPass = new BiquadFilterNode(audioCtx, {type: 'lowpass', frequency: 440})
            const delay = new DelayNode(audioCtx, {delayTime: 0.4})
            const gain = audioCtx.createGain()
            gain.gain.setValueAtTime(0.5, audioCtx.currentTime) .connect(delay)
            .connect(lowPass)
            .connect(gain)
            .connect(node)
            
            return node
        }
        
        source.connect(sbwNode).connect(b1).connect(getCombFilter(ctx)).connect(b).connect(ctx.destination);


//         let subband_filter = ctx.createAnalyser();
//          subband_filter.fftSize = 32;
//         source.connect(subband_filter);
        
//         let processor = ctx.createScriptProcessor(16384, 2, 2);
//         subband_filter.connect(processor);
//         histogram2('a1', subband_filter);
//         processor.onaudioprocess = function(e) {
//             var dataArray = new Uint8Array(ctx.sampleRate/2);
//             subband_filter.getByteFrequencyData(dataArray);

//             var dataArray2 = new Float32Array(200);
//             subband_filter.getFloatTimeDomainData(dataArray2);
//           console.log(dataArray.slice(0,100));
//           console.log(dataArray2.slice(0,200));

//          }
      //  timeseries_static({elemId:'b', analyzer:subband_filter,width:1024, height:500});
        // sbwNode.connect(a);

      //  sbwNode.connect(ctx.destionation);
      // timeseries_static({elemId:'a', analyzer:a});




      //   let processor = ctx.createScriptProcessor(ctx.sampleRate/2, 2, 2);
      //   subband_filter.connect(processor);



      // //  var lpf = ctx.createBiquadFilter();
      // //   lpf.type='lowpass';
      // //   lpf.frequency.setValueAtTime(300, ctx.currentTime)
      //   lpf.Q.value=1;
  
      //   var lhpf = ctx.createBiquadFilter();
      //   lhpf.type='highpass';
      //   lhpf.frequency.setValueAtTime(300, ctx.currentTime)
      //   lhpf.Q.value=1;
  
        // var hpf = ctx.createBiquadFilter();
        // hpf.type='highpass';
        // hpf.frequency.value=500;
        

        // var d1 = ctx.createDelay();
        // var d2  = ctx.createDelay();
        // d1.delayTime.setValueAtTime(0.1, ctx.currentTime+0.0);
        // d2.delayTime.setValueAtTime(0.1, ctx.currentTime+0.0);



        // // sbwNode.connect(lpf).connect(d1).connect(a);
        // source.connect(lpf).connect(d2).connect(a).connect(ctx.destination)
        // source.connect(lhpf).connect(d1).connect(b).connect(ctx.destination);

 
  
        histogram2('a',a);
        histogram2('b',b);
        histogram2('b',c);

      }
    }


  </script>
</body>

</html>
