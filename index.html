<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>rttt</title>
  <link rel="stylesheet" href="style.css">

  <script src="./simple-console.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  <link rel="stylesheet" href="./simple-console.css">
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

  <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>
<script src='https://hammerjs.github.io/dist/hammer.min.js'></script>
  <script src='typeahead.bundle.min.js'></script>
</head>

<body>
  <div id="overlay" style="z-index:10; display: block; 100vh">
    <div class="text page-header">
      GrepAwk Audio is a shared DSP-over-webrtc tool.

      <br>
      <p style="font-size:20px;" class="w3-black w3-padding w3-hide-medium w3-hide-small">
        <i>"Wake up in the AM and compose a beat" -- Dr. Dre</i>
      </p>


      <button type="button" class="btn btn-primary btn-block">start Audio Context. </button>
              <video width=320 id='rtc' controls playsinline src='/api/sudo/pink+noise.mp3'></video>
              <audio width=320 id='audio1' controls playsinline src='/samples/song.mp3'></audio>
    </div>
  </div>
  <nav class="navbar navbar-dark bg-dark text-light flex-md-nowrap p-0 shadow">
    <a class="navbar-brand col-sm-3 col-md-2 mr-0" href="#">GrepAwk DSP</a>
    <input id='ytsearch' class="type-ahead form-control form-control-dark w-59" type="text" placeholder="Search Music"
      aria-label="Search">
    <ul class="navbar-nav px-3">
 
      <li class="nav-item text-nowrap dropdown">
          <div class="dropdown">
          <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Listen
          </button>
          <div id='listen-menu' class="dropdown-menu" aria-labelledby="dropdownMenuButton" style='position:absolute; top:100%;right:0px;'>
  </div>

        </div>
      </li>
           <li class="nav-item text-nowrap">
       <div><button id=obs>Broadcast</button>  </div>
      </li>
    </ul>

  </nav>


  <div class="container-fluid bg-dark text-white">

    <div class="row">
      <nav class="navbar sidebar col-md-2">
        <div id=ctrls class="nav flex-column">
        </div>
        
        <input id=file type=file />;
      </nav>

      <main role="main" class="col-md-8 sp-3 col-lg-8">
      <div><h4 id=std1>Mix Sounds</h4> <button id=cplink  style='display:none'  onclick="copylink()">copy</button>

      <div id='chart' class='wrapper' style="position: relative; width: 70vw; height:300px">
      <span id=status></span>
    <canvas class="layer1" width="100" height="100" style="position: absolute; left: 0; top: 0; z-index: 1;"></canvas>
    <canvas id='layer2' class="layer2" width="100" height="100" style="position: absolute; left: 0; top: 0; z-index:0;"></canvas>
     <canvas id='output_timeline' style='position: absolute; left: 0; width:100%; top:100%; height:40%; z-index: 0;'></canvas>
    </div>
          <figure class='well' style='margin-top:200px'>
            <span id='rx0'></span>
            <span id='rx1'></span>
           <figcaption class="figure-caption">PCM 32bit sample</figcaption>

          </figure>
        <div class='d-block p-2' id="eq_update_form">
        </div>
        <div class='canvas_wrapper'>
          <div class="btn-group mr-2">
            <button id='zoomin' type="button" class="btn btn-sm btn-outline-secondary">+</button>
            <button id='zoomout' type="button" class="btn btn-sm btn-outline-secondary">-</button>
          </div>

          <figure class='well'>
            <canvas id='output_freq'></canvas>
            <figcaption class="figure-caption">FFT Bins</figcaption>

          </figure>
          <figure class='well' style='display:none'>
            <canvas id='band_freq_out'></canvas>
            <figcaption class="figure-caption">FFT Bins</figcaption>
          </figure>
        </div>
      </main>
    </div>
  </div>
  <div id=output_cp class='footer row'>
    <div class=col-md-3>
        <button id="recorder">Start Recording</button>
        <span id='rinfo'></span>
        <span id='rdownload'></span>
        </div>
    <div class=col-md-3>
            
      <div class="range-wrap">
        <output id=threshold_l> Noise Gate: Gate: </output><output class="bubble"></output>  
        <input aria-labelledby='threshold_l' type="range" min='-100' max='0' value='-80' class="range"
          name='threshold'>
      </div>
  </div>

  </div>

  <div id=console></div>

  <div id='rx2log'></div>

  <script id="mix_input" type="text/x-handlebars-template">
            <div class="ProfileCard u-cf">
              <img class="ProfileCard-avatar" src="{{thumbnail}}">
          
              <div class="ProfileCard-details">
                <div class="ProfileCard-realName">{{title}}</div>
                <div class="ProfileCard-screenName">{{channelTitle}}</div>
                <div class="ProfileCard-description">{{description}}</div>
              </div>
            </div>
          </script>

  <script id="result-template" type="text/x-handlebars-template">
            <div class="ProfileCard u-cf">
              <img class="ProfileCard-avatar" src="{{thumbnail}}">
          
              <div class="ProfileCard-details">
                <div class="ProfileCard-realName">{{title}}</div>
                <div class="ProfileCard-screenName">{{channelTitle}}</div>
                <div class="ProfileCard-description">{{description}}</div>
              </div>
            </div>
          </script>

  <script src='polyfills.js'></script>
  <script type='module'>

    var $j = jQuery.noConflict();

import equilizer from "./equalizer.js";
import Mixer from './Mixer.js';
import NoiseGate from './NoiseGate/NoiseGate.js'
import { split_band } from './splitband.js'
import AnalyzerView from "./AnalyzerView.js"
import BandPassFilterNode from './band_pass_lfc/BandPassFilterNode.js'
import BroadcasterClient from './twitch/BroadcastClient.js'
import BoardcastViewerClient from './twitch/BroadcastViewerClient.js'
import { selector, slider, numeric } from "./functions.js";
import https_rtc_client from './dsp_rtc/https_rtc_client.js';
import DrawEQ from './draw.js'
$j(".dropdown-toggle").dropdown();
let audioCtx, audioTag, eq;
const overlay = document.getElementById("overlay");
const std1 = (str)=>document.getElementById("std1").innerHTML = str;

overlay.onclick = async function (e) {
  overlay.style.display='none'

  audioCtx = new AudioContext();
  await audioCtx.audioWorklet.addModule('../band_pass_lfc/processor.js');

  window.g_audioCtx = audioCtx;

  var audioTag = await Mixer(audioCtx, "ctrls");
  var ytSearch = new Bloodhound({
    datumTokenizer: Bloodhound.tokenizers.obj.whitespace('value'),
    queryTokenizer: Bloodhound.tokenizers.whitespace,
    prefetch: '/samples/yt.json',
    remote: {
      url: '/api/yt/%QUERY',
      wildcard: '%QUERY'
    }
  });

  ytSearch.initialize();
  const template = Handlebars.compile($j("#result-template").html());
  audioTag.add_audio_tag("audio1", 5);
  const audio1 = $("#audio1");
  window.g_audioTag = audioTag;
  var noiseGate = new NoiseGate(audioCtx);
  noiseGate.port.postMessage("ping");
  noiseGate.port.onmessage = (evt) => {
    log(JSON.stringify(evt.data));
  }
  audioTag.outputNode.connect(noiseGate.input);
  var bandpassFilterNode = await new BandPassFilterNode(audioCtx);
  noiseGate.output.connect(bandpassFilterNode);



  var cursor = bandpassFilterNode;

  var compressor = new DynamicsCompressorNode(audioCtx, { threshold: -10, ratio: 20, knee: 10 });

  var group = split_band(audioCtx, [31.25, 62.5, 125, 250, 500, 1000, 2000, 4000, 8000, 16000]);
  bandpassFilterNode.connect(compressor).connect(group.input);

  $("#eq_update_form").appendChild(group.UI_EQ(bandpassFilterNode, compressor));
  cursor = group.output;

  var drawEQ = DrawEQ(audioCtx, group.bands);

  var ctv = AnalyzerView(cursor, { fft: 1024 ,onFftGot: (dataFrame,analyzer)=>{
     drawEQ.postFrameFromFFT(dataFrame,analyzer);
      
  } });

// geq.drawOverlayFrequencies(ctv.analyzer);
  ctv.histogram("output_freq", 700, 300); //, { fft: 256 })
  ctv.timeseries("output_timeline", 128, 700, 300); //, { fft: 256 })

  var recorderProcessor = audioCtx.createScriptProcessor(1024, 2, 2);
  var counter = 0;
  recorderProcessor.onaudioprocess = (e) => {

    // The input buffer is the song we loaded earlier
    var inputBuffer = e.inputBuffer;

    // The output buffer contains the samples that will be modified and played
    var outputBuffer = e.outputBuffer;
    var buffer = [];
    for (var channel = 0; channel < outputBuffer.numberOfChannels; channel++) {
      var inputData = inputBuffer.getChannelData(channel);
      var outputData = outputBuffer.getChannelData(channel);
      if (isRecording) buffer.push(inputData);

      // Loop through the 4096 samples
      for (var sample = 0; sample < inputBuffer.length; sample++) {
        // make output equal to the same as the input
        outputData[sample] = inputData[sample];
      }
    }
    if (!isRecording) return;
    rworker.postMessage({
      command: 'record',
      buffer: buffer
    });
    counter += buffer.length;
  };

  var playbackGain = audioCtx.createGain({ gain: 1 });

  ctv.analyzer.connect(recorderProcessor);

  recorderProcessor.connect(playbackGain);
  playbackGain.connect(audioCtx.destination);

  var isRecording = false;
  var chunks = [];
  const outputdiv = $("#output_cp");
  const rtcViewer = $("video#rtc")

  const playbackGainSlider = slider(outputdiv, { wrap: "inline", prop: playbackGain.gain, min: "0", max: "4", step: "0.05", label: "Local Playback gain" });
  var bv = BoardcastViewerClient({
      onEvent: log,
      mediaObjectReady: function (stream) {
         rtcViewer.srcObject = stream;
         rtcViewer.autoplay = true;
      }
    });


  if(location.hash && location.hash.substr(1)){

    var cmd = location.hash.substr(1).split("/")[0];
    var arg1 =  location.hash.substr(1).split("/")[1];
    switch(cmd){
      case 'listen':
        std1("connecting to "+arg1);
        bv.watchChannel(arg1);

        break;
      default: break;
    }

  }
  $("#obs").onclick = function (e) {
    var userId = window.location.search.replace("?", "")
      || prompt("enter display name", (localStorage.getItem("displayName") || ""))
      || ("user_" + Math.floor(Math.random() * 10));

    var peer = audioCtx.createMediaStreamDestination();
    playbackGain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
    playbackGainSlider.value = "0.001";
    recorderProcessor.connect(peer);
    localStorage.setItem("displayName", userId)
    BroadcasterClient({
      onEvent: window.log
    }).broadcastAudio(userId, peer.stream)
          std1(`Broadcasting now to <input type=text id=urlinput size=80 value='https://dsp.grepawk.com#watch/${userId}'>`);
          document.getElementById("cplink").style.display="inline"


  }

  const audio22 = $("video#rtc")
  bv.listChannels().then(channels => {
    for (const channel of Object.values(channels)) {
      var a = document.createElement("a");
      a.className='dropdown-item';
      a.onclick = function () {
        bv.watchChannel(channel.name);
      }
      a.href = "#listen:"+channel.name;
      a.innerText = channel.name;
      $("#listen-menu").append(a);
    }
});

  $("#recorder").onclick = function (e) {
    var t;
    function showCounter() {
      document.getElementById("rinfo").innerHTML = (counter / 1000) + "kb";
      t = setTimeout(showCounter, 1000);
    }
    if (isRecording == false) {
      showCounter();
      isRecording = true;
      e.target.innerText = 'Done'
    } else {
      isRecording = false;
      rworker.postMessage({
        command: "exportWAV",
        type: "audio/wav"
      })
      e.target.innerText = 'record'

      cancelAnimationFrame(t)
    }
  }
  var rworker = new Worker('recorder-worker.js');
  var rconfig = { sample: 2 << 16, channels: 1 };
  rworker.postMessage({
    command: 'init',
    config: {
      sampleRate: audioCtx.sampleRate,
      numChannels: 2,
    }
  });

  rworker.onmessage = (e) => {
    if (e.data.audioUrl) {
      log(" got url " + e.data.audioUrl)
      $("#audio2").src = e.data.audioUrl;
      $("#audio2").controls = true;
      isRecording = false;
      $("#rdownload").innerHTML = `<a href='${e.data.audioUrl}'>Download</a>`;
    }
  };

  $("#overlay").style.zIndex = -99;

  var ytSearch = new Bloodhound({
    datumTokenizer: Bloodhound.tokenizers.obj.whitespace('value'),
    queryTokenizer: Bloodhound.tokenizers.whitespace,
    prefetch: '/samples/yt.json',
    remote: {
      url: '/api/yt/%QUERY',
      wildcard: '%QUERY'
    }
  });

ytSearch.initialize();
$j('#ytsearch').typeahead(
  { hint: true, highlight: true,minLength: 1},
  { 
    name: 'ytmusic', 
    templates: {
      empty: ['<div class="empty-message">','not found','</div>'].join('\n'),
      suggestion: template
    },
    displayKey: 'title',source: ytSearch
  })
  .on('typeahead:selected', function(evt, item) {
    
    audio1.src = '/api/'+item.vid+'.mp3';
    
    return item;
  });


  window.vfs = [group, audioTag, noiseGate, bandpassFilterNode, audioCtx, group];

  window.index_stdin = function (str) {
    const cmd = str.split(" ")[0];
    const arg1 = str.split(" ")[1] || "";
    const arg2 = str.split(" ")[2] || "";
    switch (cmd) {
      case 'debug':
        switch (arg1) {
          case 'group': group.aggregate_fr(); break;
          default: break;
        }
      case "ls":
        return JSON.stringify(window.g_audioTag)
        break;
      case 'fullscreen':
      case 'terminal':
      case 'term':
        $("#app1").style.display = 'none';
        con.element.style.height = '100vh';
        return true;
      case "ls":
        var str = window.vfs.map(obj => objs.toString()).forEach(str => log(str));
        log(str);
        return true;
      case 'v':
      case 'video':

        g_audioTag.loadURLTo("/api" + arg1 + ".mp3", 1);
      default: return false;
    }
  }



  con.element.style.zIndex = 99;
  con.element.addEventListener("click", function () { this.querySelector("input").focus() });
  window.onkeydown = function (evt) {
    if (evt.code == "Enter") {
      con.element.querySelector("input").focus();
    }
  }


  var blobbb = window.URL || window.webkitURL;

  document.getElementById('file').addEventListener('change', function (event) {
    var file = this.files[0];
    var fileURL = blobbb.createObjectURL(file);
    $("#audio2").src = fileURL;
    $("#audio2").autoplay = true;
  });
}
window.copylink=function(){
  document.getElementbyId("urlinput").select();
  document.select()
  document.copy();
  this.innerText='copied'
} 



  </script>

</body>

<script>

</script>

</html>
<template>
<h4 id='title'>${this.title}<h4>
<h5 id='status'></h5>
<span class="controls">
  <select id='select'>
  ${this.selectOptions.map( option=>`
    <option value=${option.value}>${option.display}</option>
  `)}
  </select>
  <span id='btn-group' class='btn-group'>
  </span>
    <button id='play' class="btn btn-primary">
     Play
    </button>
    <button id='mute' class="btn btn-primary">
      <i class="fa fa-volume-off"></i>
    </button>
    <input value='1.0' min='0.0' max='3.0' type=slider></input>
</span>
</template>
