<html>
<link rel="stylesheet" href="../../style.css">

<body class=simple-console>
  <a  id=btn> click to start</a>
<div>
</div>
<div>
  <canvas width='1020' height=400></canvas>

</div>
</body>


<script>
  async function  main(){
    var canvas = document.querySelector("canvas");
    var canvasCtx = canvas.getContext("2d");
    canvas.setAttribute('width',canvas.parentElement.clientWidth);
    canvas.setAttribute('height',canvas.parentElement.clientHeight);
    var WIDTH = canvas.width;
    var HEIGHT = canvas.height;
    canvasCtx.clearRect(0,0,WIDTH,HEIGHT);
    canvasCtx.lineWidth = 2;
    canvasCtx.lineWidth = 2;
    canvasCtx.strokeStyle = 'rgb(0, 0, 0)';
    canvasCtx.beginPath();  

    var x = 0,y=0;
    
    canvasCtx.moveTo(0,0);



    const div = document.querySelector('div');
    const audioCtx = new AudioContext()

    audioCtx.audioWorklet.addModule('./spl_dba_worklet.js')
      .then(() => {
        let ctx = audioCtx;

        let url = 'http://localhost/samples/lana.mp3';

       let source = ctx.createBufferSource();

       var r = new AudioWorkletNode(audioCtx, 'spl_dba');

        
       r.port.onmessage=(e)=>{
         div.innerHTML= e.data.spl;
         x++;
         y = parseFloat(e.data.spl)*800;
         
         if(x >= WIDTH) { 
           x = 0;

           canvasCtx.clearRect(0,0,WIDTH,HEIGHT);
           canvasCtx.stroke();

           canvasCtx.moveTo(x,y);

         }
         canvasCtx.lineTo(x,y);
         canvasCtx.stroke();

       }
    canvas.setAttribute('width',canvas.parentElement.clientWidth);
    canvas.setAttribute('height',canvas.parentElement.clientHeight);
    var WIDTH = canvas.width;
    var HEIGHT = canvas.height;
    canvasCtx.clearRect(0,0,WIDTH,HEIGHT);
    canvasCtx.lineWidth = 2;
    canvasCtx.lineWidth = 2;
    canvasCtx.strokeStyle = 'rgb(299,200,200)';
   
    canvasCtx.beginPath();  
    var x = 0,y=0;

    

        let xhr = new XMLHttpRequest();
        xhr.open("GET",url,true);
        xhr.responseType = 'arraybuffer';
        xhr.onload = function(){
          var audioData = xhr.response;
          try{
              ctx.decodeAudioData(audioData, function(buffer_){
                source.buffer = buffer_;
                source.connect(r);
                r.connect(ctx.destination);
                source.start();
              });
            }catch(e){
              console.log(e);
            }

          }
          xhr.send();


        }).catch(e => console.error(e))



      function startMeters(ctx){

      }

  //   // Loads module script via AudioWorklet.
  //   audioCtx.audioWorklet.addModule('reverb-processor.js')
  //     .then(() => getLiveAudio(audioCtx))
  //     .then((liveIn) => {
  //       // After the resolution of module loading, an AudioWorkletNode can be constructed.
  //       let reverbWorkletNode = new AudioWorkletNode(audioCtx,'reverb-processor')

  //       // AudioWorkletNode can be interoperable with other native AudioNodes.
  //       liveIn.connect(reverbWorkletNode).connect(audioCtx.destination)

  //     })
  //     .catch(e => console.error(e))

  //   function getLiveAudio(audioCtx) {
  //     return navigator.mediaDevices.getUserMedia({
  //       audio: true
  //     })
  //       .then(stream => audioCtx.createMediaStreamSource(stream))
  //   }
  }

  document.querySelector("a").onclick=main;
</script>

</html>