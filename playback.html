<!DOCTYPE html>
<html>
  <head>
    <title>Spotify Web Playback SDK Quick Start Tutorial</title>
  </head>
  <button style="display: none;" id="loginBtn">Login With Spotify</button>
<button  style="display: none;" id='play'>play</button>
  <div id="console"></div>
  <body>
    <script>
      const loginBtn = document.querySelector("#loginBtn");
      const log = (msg) => (document.getElementById("console").innerHTML += "<br>" + msg);
      const error = log;
      const scope = [
        "user-read-playback-state",
        "user-modify-playback-state",
        "user-read-currently-playing",
        "streaming",
        "app-remote-control",
      ];

      const token =
        location.hash &&
        location.hash.match(/access_token\=(.*?)\&/)[0].replace("access_token=", "");
      if (!token) {
        loginBtn.style.display = "block";
        loginBtn.onclick = () =>
          (document.location =
            "https://dsp.grepawk.com/api/spotify/login?scope=" +
            scope.join(",") +
            "&jshost=" +
            document.location.origin);
      } else {
        var script = document.createElement("script");
        script.type = "text/javascript";
        script.src = "https://sdk.scdn.co/spotify-player.js";
        document.getElementsByTagName("head")[0].appendChild(script);
	
        document.head.appendChild(
          document.createElement("script", { src: "https://sdk.scdn.co/spotify-player.js" })
        );
        var player;

        window.onSpotifyWebPlaybackSDKReady = () => {
          const player = new Spotify.Player({
            name: "Web Playback SDK Quick Start Player",
	     getOAuthToken: cb => cb(token)
          });

          // Error handling
          player.addListener("initialization_error", ({ message }) => {
            error('init '+message);
          });
          player.addListener("authentication_error", ({ message }) => {
  //          error(message);
          });
          player.addListener("account_error", ({ message }) => {
//            error(message);
          });
          player.addListener("playback_error", ({ message }) => {
            error(message);
          });
          // Playback status updates
          player.addListener("player_state_changed", (state) => {
            log(state);
          });

          // Ready
	  let deviceId;
          player.addListener("ready", (e) => {
		deviceId = e.device_id;
		document.getElementById("play").style.display='block';
          });

          // Not Ready
          player.addListener("not_ready", ({ device_id }) => {
            log("Device ID has gone offline", device_id);
          });

          // Connect to the player!
          player.connect();

          document.getElementById("play").onclick = function () {	
		fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
			method: 'PUT',
      			body: JSON.stringify({ uris: ['spotify:track:7xGfFoTpQ2E7fRF5lN10tr'] }),
	      		headers: {
        			'Content-Type': 'application/json',
        			'Authorization': `Bearer ${token}`
      				},
    			});
    	      };
        };
      }
    </script>
    <!-- We will insert our code here. -->
  </body>
</html>
