<html>
    <head>
        <title>Spotify Premium Player</title>

        <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" crossorigin/>
    </head>
    <body>
<style> 
body{
    width:100vw;
    height:100vh;
    overflow: hidden;
    background-color:black;
    color: white;
}
#container{
    display: grid;
    width: 100vw;
    height:100vh;
    grid-gap: 10px;
    color: white;
}


.header {
    grid-row: 1/2;
    grid-column: 2 / 5;
    background-color: #222222;
}
.sidenav {
    grid-column: 1;
    grid-row: 1 / 4;
    background-color: #333333;
    
}

.main{
    grid-column: 2 / 4;
    grid-row: 2 / 8;
    background-color:#555555;
}
.nowplaying{
    grid-column: 4 / 5;
    grid-row: 2 / 8;
    background-color:#555555;  
}
.localchannel{
    grid-column: 1;
    grid-row: 4/ 5;
    background-color: #333333;
    
}
.band_freq_out{
    grid-column: 1;
    grid-row: 6/7;
    background-color: #333333;
    
}


.footer{
    padding:20px;
    grid-row: 8/10;
    grid-column: 1 / 5;
    background-color: #333333;
}
button{
        display: inline-block;
        color: white;
        background-color: blueviolet;
        padding: 0 2rem;
        font-size: 1rem;
        border-radius: 2px;
        letter-spacing: .5px;
        text-align: center;
        text-decoration: none;
        height: 36px;
        line-height: 36px;
        cursor: pointer;
        box-shadow: 
          0 2px 2px 0 rgba(0,0,0,0.14), 
          0 1px 5px 0 rgba(0,0,0,0.12), 
          0 3px 1px -2px rgba(0,0,0,0.2)   
}

.song-controls button{
    cursor:pointer;
}
</style>
<div id=container>
    <div class=header id='header'>
        <span id='welcome'></span>
    
    
    </div>
    <div class=sidenav id='playlist'>

    </div>
    <div class='band_freq_out'>
        <canvas id='band_freq_out'></canvas>
    </div>
    <div class='localchannel'>
        <audio controls autoplay id=localstream></audio>
    </div>
    <div class=main id='tracklist'>

    </div>
    <div class='nowplaying' class="d-flex justify-content-center">
        <div class='card'>
          <img class='song-thumbnail' width=300 height=300 >
            <div class="container">
                <h4 class='song-name'></h4>
                <p class='artist-name'></p>
            </div>
        </div>
        <button id=shareAudio>Share Audio</button>
        <div id='debug'></div>
    </div>
   
    <div class=footer>  
         <div id=player class="container song-player-container" 
            style='position:relative; width:100%; height:100%'>
                                
            <div class="sliderr">
                 <span class='position'></span> 
                 <span><input type=range style='width:80%' id='progress' min=0 max="100"></input></span>
                   <span class='duration'></span>
            </div>
   
            <div class="song-controls" style='display:grid; height:50px; width: 300px; grid-gap:10px'>
                <button id=rewind class="rewind" style="grid-column:1/2">
                    <i class="fa fa-backward"> </i>
                </button>
                <button id="play" class="play-btn" style="grid-column:2/3">
                    <i class="fa fa-play"> </i>
                </button>

                <button id=stop class="pause-btn"  style="grid-column:2/3; display:none">
                    <i class="fa fa-stop" aria-hidden="true"> </i>
                </button>


                <button id=forward class="next-song"  style="grid-column:3/4">
                    <i class="fa fa-step-forward forward" aria-hidden="true"></i>
                </button>
            </div>
            <div id='nexttracks'  style='position:absolute; right:3em; width:200px; height:100%; overflow-y:scroll'>
            </div>
        </div>
    </div>



</div>

    <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script> -->
    <script type="module">
    
        import {checkAuth, getPlayList} from "./radio/spotifyClient.jsx";
        import BroadcasterClient from './twitch/BroadcastClient.js'
        import AnalyzerView from "./AnalyzerView.js"
        const token = checkAuth({containerId: "welcome"});
        const localChannel = document.getElementById("localstream");
        let ctx;
        if (token) {
            getPlayList(token, "playlist");

        }
        document.querySelector("#shareAudio").onclick=async ()=>{
            var userId = window.location.search.replace("?", "")
            || prompt("enter display name", (localStorage.getItem("displayName") || ""))
            || ("user_" + Math.floor(Math.random() * 10));

            try{
                ctx = ctx || new AudioContext();
                const stream =  await navigator.mediaDevices.getDisplayMedia({audio:true, video:true});  
                localChannel.srcObject= stream;
                localChannel.muted = true;
                var source = ctx.createMediaStreamSource(stream);
                var av =  AnalyzerView(source, { fft: 1024});
                av.histogram("band_freq_out");
                av.connect(new GainNode(ctx, {gain:0})).connect(ctx.destination);
      
                BroadcasterClient({
                    onEvent: window.log
              }).broadcastAudio(userId, stream);
            }catch(e){
                
            }



        }
    </script>
    </body>
</html>

